<!-- templates/views/common/header.html -->
<th:block th:fragment="header-fragment"
          xmlns:sec="http://www.thymeleaf.org/extras/spring-security">


    <!-- Bootstrap CSS (모달 숨김·레이어 오버레이 등 스타일을 위해 반드시 필요) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
          rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/header.css}">

    <style>
        /* 모달 기본은 숨기고, show 클래스 붙었을 때만 보이도록 */
        #headerMapModal {
            display: none !important;
        }
        #headerMapModal.show {
            display: block !important;
        }
    </style>

    <header class="site-header">
        <div class="header__inner">
            <!-- 로고 -->
            <div class="header__logo">
                <a th:href="@{/}">ROOFY</a>
            </div>

            <!-- 네비게이션 래퍼 -->
            <nav class="header__nav-wrapper">
                <ul class="header__nav">
                    <!-- 로그인했을 때만 보일 메뉴 (일반 사용자) -->
                    <li sec:authorize="isAuthenticated() and !hasRole('ADMIN')">
                        <a href="#"
                           class="nav-item"
                           onclick="openMapFromHeader()"
                           th:text="${#authentication.principal.user.areaName}">
                            위치
                        </a>
                    </li>
                    <li sec:authorize="isAuthenticated() and !hasRole('ADMIN')">
                        <span class="nav-item"
                              th:text="${#authentication.principal.user.name}">닉네임</span>
                    </li>
                    <li sec:authorize="isAuthenticated() and !hasRole('ADMIN')">
                        <a class="nav-item" th:href="@{/mypage}">마이페이지</a>
                    </li>

                    <!-- 로그인 안 했을 때만 보일 메뉴 -->
                    <li sec:authorize="!isAuthenticated()">
                        <a class="nav-item" th:href="@{/user/login}">로그인</a>
                    </li>

                    <!-- 로그인했을 때만 보일 메뉴 -->
                    <li sec:authorize="isAuthenticated() and !hasRole('ADMIN')">
                        <a class="nav-item" th:href="@{/user/logout}">로그아웃</a>
                    </li>
                </ul>

                <!-- 관리자용 메뉴 (필요 시 보여줌) -->
                <ul class="header__nav" sec:authorize="hasRole('ADMIN')">
                    <li>
                        <span class="nav-item"
                              th:text="${#authentication.principal.user.name}">관리자명</span>
                    </li>
                    <li sec:authorize="!isAuthenticated()">
                        <a class="nav-item" th:href="@{/user/login}">로그인</a>
                    </li>
                    <li sec:authorize="isAuthenticated()">
                        <a class="nav-item" th:href="@{/user/logout}">로그아웃</a>
                    </li>
                </ul>
            </nav>
        </div>
    </header>

    <!-- 지도 띄울 모달 -->
    <!-- 지도 띄울 모달 -->
    <div class="modal fade"
         id="headerMapModal"
         tabindex="-1"
         role="dialog"
         aria-labelledby="headerMapModalLabel">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="headerMapModalLabel">내 위치</h5>
                    <button type="button"
                            class="btn-close"
                            data-bs-dismiss="modal"
                            aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="headerMap" style="width: 75%; height: 300px; border: 1px solid black"></div>
                    <p><strong>행정구역:</strong> <span id="headerAddressOutput">-</span></p>
                </div>
            </div>
        </div>
    </div>


    <!-- ③ jQuery 먼저 로드 -->
    <script
            src="https://code.jquery.com/jquery-3.6.0.min.js">
    </script>

    <!-- ④ location.js (jQuery 이후) -->
    <script th:src="@{/js/location.js}"></script>

    <!-- ⑤ openMapFromHeader 함수 -->
    <script>
        function openMapFromHeader() {
            const modalEl = document.getElementById("headerMapModal");
            // ① Bootstrap 모달 인스턴스 생성 및 열기
            const bsModal = new bootstrap.Modal(modalEl);
            bsModal.show();

            // ② 실제 DOM이 보여진 직후에만 지도를 초기화
            modalEl.addEventListener("shown.bs.modal", () => {
                openMap("headerMap", "headerMapModal", "headerAddressOutput");
            }, {once: true});
        }
    </script>

    <!-- ⑥ Bootstrap JS Bundle (integrity 제거) -->
    <script
            src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js">
    </script>
</th:block>
